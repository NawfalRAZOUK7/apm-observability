# ==========================================================================
# docker/backup/pgbackrest-server.conf
# pgBackRest SERVER config â€” Option 2 (TLS server / mTLS) + MinIO (S3 over HTTPS)
#
# Mounted into the "pgbackrest-server" container at:
#   /etc/pgbackrest/pgbackrest.conf
# ==========================================================================

[global]
log-level-console=info
process-max=2

# ------------------------------
# Repository: MinIO (S3)
# ------------------------------
repo1-type=s3
repo1-path=/pgbackrest
repo1-s3-endpoint=https://minio:9000
repo1-s3-bucket=pgbackrest
repo1-s3-uri-style=path
repo1-s3-region=us-east-1

# Must match docker-compose.backup.yml MINIO_ROOT_USER/PASSWORD
repo1-s3-key=apm_backup
repo1-s3-key-secret=apm_backup_secret

# Verify MinIO TLS using mounted CA/cert (preferred "storage" options)
repo1-storage-verify-tls=y
repo1-storage-ca-file=/certs/public.crt

# Keep a small retention in dev
repo1-retention-full=2

# Option 2 (no WAL archiving for now): disable archive checks
archive-check=n
archive-mode-check=n

# ------------------------------
# TLS SERVER (pgBackRest host protocol)
# ------------------------------
[global:server]
tls-server-address=0.0.0.0
tls-server-port=8432

tls-server-ca-file=/certs/pgbackrest/ca.crt
tls-server-cert-file=/certs/pgbackrest/server.crt
tls-server-key-file=/certs/pgbackrest/server.key

# Authorize clients by certificate Common Name (CN)
# Format: <client-cn>=<stanza>
# Client CN generated by docker/certs/gen_pgbackrest_mtls.sh: "pgbr-client"
tls-server-auth=pgbr-client=apm

# ------------------------------
# Stanza: apm
# ------------------------------
[apm]
# Data directory (mounted read-only from backup_db_data volume)
pg1-path=/var/lib/postgresql/data

# Connection to Postgres for metadata (TCP to db service)
pg1-host=db
pg1-port=5432
pg1-user=apm
pg1-database=apm
