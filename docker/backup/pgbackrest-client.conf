# ==========================================================================
# docker/backup/pgbackrest-client.conf
# pgBackRest CLIENT config — Option 2 (TLS server / mTLS) + MinIO (S3 over HTTPS)
#
# Mounted into the "pgbackrest" (client) container at:
#   /etc/pgbackrest/pgbackrest.conf
#
# Notes:
# - stanza-create requires pg1-path (even when using a remote host).
# - Client connects to the pgBackRest TLS server on port 8432.
# - For MinIO, force path-style to avoid bucket-as-subdomain DNS issues.
# ==========================================================================

[global]
log-level-console=info
process-max=2

# ------------------------------
# Repository: MinIO (S3)
# ------------------------------
repo1-type=s3
repo1-path=/pgbackrest
repo1-s3-endpoint=https://minio:9000
repo1-s3-bucket=pgbackrest
repo1-s3-uri-style=path
repo1-s3-region=us-east-1

# Must match docker-compose.backup.yml MINIO_ROOT_USER/PASSWORD
repo1-s3-key=apm_backup
repo1-s3-key-secret=apm_backup_secret

# Verify MinIO TLS using mounted CA/cert (preferred "storage" options)
repo1-storage-verify-tls=y
repo1-storage-ca-file=/certs/public.crt

# Keep a small retention in dev
repo1-retention-full=2

# Option 2 (no WAL archiving for now): disable archive checks
archive-check=n
archive-mode-check=n

# ------------------------------
# Stanza: apm — remote host protocol over TLS (client -> pgbackrest-server)
# ------------------------------
[apm]
# REQUIRED by stanza-create
pg1-path=/var/lib/postgresql/data

# Explicit DB metadata connection settings
pg1-port=5432
pg1-user=apm
pg1-database=apm

# Host protocol (TLS)
pg1-host=pgbackrest-server
pg1-host-type=tls
pg1-host-port=8432

# mTLS material (generated by docker/certs/gen_pgbackrest_mtls.sh)
pg1-host-ca-file=/certs/pgbackrest/ca.crt
pg1-host-cert-file=/certs/pgbackrest/client.crt
pg1-host-key-file=/certs/pgbackrest/client.key
