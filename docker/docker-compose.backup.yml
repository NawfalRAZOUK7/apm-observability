# ============================================================================
# docker/docker-compose.backup.yml
# Option 2 â€” pgBackRest TLS server (mTLS) + db-init + MinIO + minio-init
# ============================================================================

services:
  pg_socket_init:
    image: alpine:3.20
    user: "0"
    volumes:
      - pg_socket:/var/run/postgresql
    networks:
      - backup_network
    restart: "no"
    command: ["sh", "-euc", "mkdir -p /var/run/postgresql && chown -R 999:999 /var/run/postgresql && chmod 2775 /var/run/postgresql"]

  db:
    image: timescale/timescaledb:latest-pg16
    depends_on:
      pg_socket_init:
        condition: service_completed_successfully
    environment:
      POSTGRES_USER: apm
      POSTGRES_DB: apm
      POSTGRES_PASSWORD: apm
    volumes:
      - backup_db_data:/var/lib/postgresql/data
      - pg_socket:/var/run/postgresql
      - ./initdb:/docker-entrypoint-initdb.d:ro
    networks:
      - backup_network
    restart: unless-stopped
    command: ["postgres", "-c", "unix_socket_directories=/var/run/postgresql"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U apm -d apm"]
      interval: 3s
      timeout: 3s
      retries: 40

  db-init:
    image: timescale/timescaledb:latest-pg16
    depends_on:
      db:
        condition: service_healthy
    networks:
      - backup_network
    environment:
      PGHOST: db
      PGPORT: "5432"
      PGUSER: apm
      PGPASSWORD: apm
      PGDATABASE: apm
    volumes:
      - ./backup/db-init.sh:/db-init.sh:ro
    restart: "no"
    command: ["bash", "/db-init.sh"]

  minio:
    build:
      context: ..
      dockerfile: docker/minio/Dockerfile
    command: ["server", "/data", "--console-address", ":9001"]
    user: "0"
    ports:
      - "${BACKUP_MINIO_API_HOST_PORT:-9000}:9000"
      - "${BACKUP_MINIO_CONSOLE_HOST_PORT:-9001}:9001"
    volumes:
      - minio_data:/data
      - ./certs:/root/.minio/certs:ro
    environment:
      - MINIO_ROOT_USER=apm_backup
      - MINIO_ROOT_PASSWORD=apm_backup_secret
      - MINIO_SERVER_URL=https://minio:9000
      - MINIO_BROWSER=on
    networks:
      - backup_network
    restart: unless-stopped

  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_started
    networks:
      - backup_network
    environment:
      MINIO_ENDPOINT: https://minio:9000
      MINIO_ROOT_USER: apm_backup
      MINIO_ROOT_PASSWORD: apm_backup_secret
      MINIO_BUCKET: pgbackrest
      MINIO_ALIAS: myminio
      MINIO_ENABLE_VERSIONING: "1"
      MINIO_INSECURE: "1"
    volumes:
      - ./minio/init.sh:/init.sh:ro
    restart: "no"
    entrypoint: ["sh", "-lc", "sh /init.sh"]

  pgbackrest-server:
    build:
      context: ..
      dockerfile: docker/pgbackrest/Dockerfile
    depends_on:
      db:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
      minio:
        condition: service_started
      minio-init:
        condition: service_completed_successfully
    volumes:
      - backup_db_data:/var/lib/postgresql/data:ro
      - pg_socket:/var/run/postgresql
      - ./backup/pgbackrest-server.conf:/etc/pgbackrest/pgbackrest.conf:ro
      - ./backup/pgpass:/root/.pgpass:ro
      - ./certs:/certs:ro
      - backup_data:/var/lib/pgbackrest
    environment:
      - PGBACKREST_CONFIG=/etc/pgbackrest/pgbackrest.conf
    networks:
      - backup_network
    restart: unless-stopped
    command: ["bash", "-lc", "exec pgbackrest server"]

  pgbackrest:
    build:
      context: ..
      dockerfile: docker/pgbackrest/Dockerfile
    depends_on:
      pgbackrest-server:
        condition: service_started
    volumes:
      - ./backup/pgbackrest-client.conf:/etc/pgbackrest/pgbackrest.conf:ro
      - ./certs:/certs:ro
      - backup_data:/var/lib/pgbackrest
    environment:
      - PGBACKREST_CONFIG=/etc/pgbackrest/pgbackrest.conf
    networks:
      - backup_network
    restart: "no"
    command: ["sleep", "infinity"]

volumes:
  backup_db_data:
  backup_data:
  minio_data:
  pg_socket:

networks:
  backup_network:
    driver: bridge