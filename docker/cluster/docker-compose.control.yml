# docker/cluster/docker-compose.control.yml
services:
  minio:
    build:
      context: ../..
      dockerfile: docker/minio/Dockerfile
    command: ["server", "/data", "--console-address", ":9001"]
    user: "0"
    ports:
      - "${CONTROL_BIND_IP:-0.0.0.0}:${CLUSTER_CONTROL_MINIO_API_HOST_PORT:-9000}:9000"
      - "${CONTROL_BIND_IP:-0.0.0.0}:${CLUSTER_CONTROL_MINIO_CONSOLE_HOST_PORT:-9001}:9001"
    volumes:
      - minio_data:/data
      - ../certs:/root/.minio/certs:ro
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-apm_backup}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-apm_backup_secret}
      - MINIO_SERVER_URL=https://minio:9000
      - MINIO_BROWSER=on
    restart: unless-stopped

  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_started
    environment:
      MINIO_ENDPOINT: https://minio:9000
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-apm_backup}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-apm_backup_secret}
      MINIO_BUCKET: ${MINIO_BUCKET:-pgbackrest}
      MINIO_ALIAS: myminio
      MINIO_ENABLE_VERSIONING: "1"
      MINIO_INSECURE: "1"
    volumes:
      - ../minio/init.sh:/init.sh:ro
    restart: "no"
    entrypoint: ["sh", "-lc", "sh /init.sh"]

  pgbackrest:
    build:
      context: ../..
      dockerfile: docker/pgbackrest/Dockerfile
    depends_on:
      minio-init:
        condition: service_completed_successfully
    volumes:
      - ../backup/pgbackrest-client.conf:/etc/pgbackrest/pgbackrest.conf:ro
      - ../certs:/certs:ro
      - pgbackrest_spool:/var/lib/pgbackrest
    environment:
      - PGBACKREST_CONFIG=/etc/pgbackrest/pgbackrest.conf
    # Garde ton nom: pgbackrest-server r√©sout vers l'IP du DATA node
    extra_hosts:
      - "pgbackrest-server:${DATA_NODE_IP}"
    restart: "no"
    command: ["sleep", "infinity"]

volumes:
  minio_data:
  pgbackrest_spool: